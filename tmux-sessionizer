#!/usr/bin/env bash

# --- Configuration ---
PATH_FILE="$HOME/dotfiles/tmux-paths.md"
SEARCH_PATHS=()

# Check if file exists
if [[ ! -f "$PATH_FILE" ]]; then
    echo "Error: Path file not found at $PATH_FILE"
    exit 1
fi

# --- Parsing Logic ---
while IFS= read -r line; do
    # Skip empty lines
    [[ -z "$line" ]] && continue

    # 1. Strip Markdown bullets (* or -) and leading whitespace
    # Matches start of line, optional *, optional space
    clean_line=$(echo "$line" | sed 's/^[* -]*\s*//')

    # 2. Remove all double quotes (") from the remaining string
    # Input: "$HOME/dotfiles" -> Output: $HOME/dotfiles
    clean_line="${clean_line//\"/}"

    # 3. Manually expand the literal text '$HOME' to actual Home path
    # Input: $HOME/dotfiles -> Output: /home/user/dotfiles
    expanded_line="${clean_line/\$HOME/$HOME}"

    # 4. Add to array only if it is a valid directory
    if [[ -d "$expanded_line" ]]; then
        SEARCH_PATHS+=("$expanded_line")
    fi
done < "$PATH_FILE"

# --- The Selection Logic ---
selected=$(find "${SEARCH_PATHS[@]}" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | fzf \
    --prompt="î¯Š Switch to Project: " \
    --height=50% \
    --layout=reverse \
    --border=rounded \
    --info=inline \
    --preview 'ls --color=always -F {} | head -20' \
    --preview-window='right:50%:wrap')

# --- Exit Handling ---
if [ -z "$selected" ]; then
    exit 0
fi

# --- Session Setup ---
session_name=$(basename "$selected" | tr . _)

if ! tmux has-session -t="$session_name" 2> /dev/null; then
    tmux new-session -s "$session_name" -c "$selected" -d
fi

# --- Switching Logic ---
if [ -n "$TMUX" ]; then
    tmux switch-client -t "$session_name"
else
    tmux attach-session -t "$session_name"
fi
