#!/usr/bin/env bash

# --- Configuration ---
# Update this to point to your new plain text file
PATH_FILE="$HOME/dotfiles/utils/tmuxscripts/tmux-paths.md"
SEARCH_PATHS=()

# Check if file exists
if [[ ! -f "$PATH_FILE" ]]; then
    echo "Error: Path file not found at $PATH_FILE"
    exit 1
fi

# --- Parsing Logic (Simplified) ---
while IFS= read -r line; do
    # 1. Skip empty lines or lines starting with # (comments)
    [[ -z "$line" || "$line" =~ ^# ]] && continue

    # 2. Trim leading/trailing whitespace
    clean_line=$(echo "$line" | xargs)

    # 3. Expansion: Handle $HOME or ~ if used in the text file
    # This allows both "/home/sybil/..." and "$HOME/..." to work
    expanded_line="${clean_line/\$HOME/$HOME}"
    expanded_line="${expanded_line/\~/$HOME}"

    # 4. Add to array only if it is a valid directory
    if [[ -d "$expanded_line" ]]; then
        SEARCH_PATHS+=("$expanded_line")
    fi
done < "$PATH_FILE"

# --- The Selection Logic ---
# Note: -mindepth 1 scans the *subdirectories* of the paths in your file.
# If you want the paths in the file to BE the projects, change to -mindepth 0 -maxdepth 0
selected=$(find "${SEARCH_PATHS[@]}" -mindepth 0 -maxdepth 0 -type d 2>/dev/null | fzf \
    --prompt="î¯Š Switch to Project: " \
    --height=50% \
    --layout=reverse \
    --border=rounded \
    --info=inline \
    --preview 'ls --color=always -F {} | head -20' \
    --preview-window='right:50%:wrap')

# --- Exit Handling ---
if [ -z "$selected" ]; then
    exit 0
fi

# --- Session Setup ---
session_name=$(basename "$selected" | tr . _)

if ! tmux has-session -t="$session_name" 2> /dev/null; then
    tmux new-session -s "$session_name" -c "$selected" -d
fi

# --- Switching Logic ---
if [ -n "$TMUX" ]; then
    tmux switch-client -t "$session_name"
else
    tmux attach-session -t "$session_name"
fi
